<script type="module">
// -----------------------------
// FIREBASE SETUP
// -----------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDB4SOUmddsEbhs_HHsrRGUBDX5PLU9hiE",
  authDomain: "huanger-films.firebaseapp.com",
  databaseURL: "https://huanger-films-default-rtdb.firebaseio.com",
  projectId: "huanger-films",
  storageBucket: "huanger-films.firebasestorage.app",
  messagingSenderId: "790500951380",
  appId: "1:790500951380:web:c8a93a4b21caef24d174c1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// -----------------------------
// GLOBALS
// -----------------------------
const START_HOUR = 7, END_HOUR = 20;
let bookings = {}; // Firebase realtime sync

// Sync realtime bookings
onValue(ref(db, "bookings"), snap => {
  bookings = snap.exists() ? snap.val() : {};
  render();
});

// Helpers
function pad(n){ return String(n).padStart(2,'0'); }
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function hourLabel(h){ return `${pad(h)}:00`; }
function isBooked(date, hour){ return bookings?.[date]?.[hour] === true; }

// -----------------------------
// MOCK PAYMENT POPUP
// -----------------------------
function mockPay(date, hour) {
  const ok = confirm(`Mock Payment\n\nBook ${date} at ${hourLabel(hour)}?\n`);
  if (!ok) return;

  set(ref(db, `bookings/${date}/${hour}`), true);
  alert("Booking confirmed!");
}

// -----------------------------
// ELEMENTS
// -----------------------------
const monthBtn = document.getElementById('monthBtn');
const weekBtn = document.getElementById('weekBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const labelEl = document.getElementById('label');
const monthView = document.getElementById('monthView');
const weekView = document.getElementById('weekView');
const monthGrid = document.getElementById('monthGrid');
const weekHeader = document.getElementById('weekHeader');
const weekBody = document.getElementById('weekBody');

let view = "week";
let cursor = new Date();

monthBtn.onclick = () => {
  view = "month";
  monthView.style.display = "block";
  weekView.style.display = "none";
  renderMonth();
};

weekBtn.onclick = () => {
  view = "week";
  monthView.style.display = "none";
  weekView.style.display = "block";
  renderWeek();
};

prevBtn.onclick = () => {
  view === "week"
    ? cursor.setDate(cursor.getDate() - 7)
    : cursor.setMonth(cursor.getMonth() - 1);
  render();
};

nextBtn.onclick = () => {
  view === "week"
    ? cursor.setDate(cursor.getDate() + 7)
    : cursor.setMonth(cursor.getMonth() + 1);
  render();
};

// -----------------------------
// MONTH VIEW
// -----------------------------
function renderMonth() {
  monthGrid.innerHTML = "";
  labelEl.textContent = cursor.toLocaleString(undefined, { month: "long", year: "numeric" });

  const y = cursor.getFullYear();
  const m = cursor.getMonth();
  const first = new Date(y, m, 1);
  const startDay = first.getDay();
  const start = new Date(first);
  start.setDate(first.getDate() - startDay);

  for (let i = 0; i < 42; i++) {
    const d = new Date(start);
    d.setDate(start.getDate() + i);

    const dateKey = ymd(d);

    const card = document.createElement("div");
    card.className = "day-card";

    card.innerHTML = `
      <div class="day-num">${d.getDate()}</div>
      <div class="small-muted">${d.toLocaleDateString(undefined, { weekday: 'short' })}</div>
    `;

    const wrap = document.createElement("div");
    wrap.style.marginTop = "8px";

    for (let h = START_HOUR; h < START_HOUR + 3; h++) {
      const slot = document.createElement("span");
      const booked = isBooked(dateKey, h);

      slot.className = "slot " + (booked ? "booked" : "available");
      slot.textContent = hourLabel(h);

      if (!booked) {
        slot.onclick = event => {
          event.stopPropagation();
          mockPay(dateKey, h);
        };
      }

      wrap.appendChild(slot);
    }

    card.appendChild(wrap);
    monthGrid.appendChild(card);
  }
}

// -----------------------------
// WEEK VIEW
// -----------------------------
function getWeekStart(d) {
  const dd = new Date(d);
  const day = dd.getDay();
  const monday = new Date(dd);
  monday.setDate(dd.getDate() - (day === 0 ? 6 : day - 1));
  return monday;
}

function renderWeek() {
  weekHeader.innerHTML = "";
  weekBody.innerHTML = "";

  const monday = getWeekStart(cursor);
  const dates = [];

  weekHeader.appendChild(document.createElement("div")); // corner

  for (let i = 0; i < 7; i++) {
    const dt = new Date(monday);
    dt.setDate(monday.getDate() + i);
    dates.push(dt);

    const head = document.createElement("div");
    head.className = "week-head";
    head.textContent = dt.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric"
    });
    weekHeader.appendChild(head);
  }

  labelEl.textContent = `${dates[0].toLocaleDateString()} â€” ${dates[6].toLocaleDateString()}`;

  for (let h = START_HOUR; h < END_HOUR; h++) {
    const timeCol = document.createElement("div");
    timeCol.className = "time-cell";
    timeCol.innerHTML = `<strong>${hourLabel(h)}</strong>`;
    weekBody.appendChild(timeCol);

    for (let i = 0; i < 7; i++) {
      const key = ymd(dates[i]);

      const cell = document.createElement("div");
      cell.className = "day-col";

      const box = document.createElement("div");
      const booked = isBooked(key, h);

      if (booked) {
        box.className = "hour-box hour-booked";
        box.textContent = "Booked";
      } else {
        box.className = "hour-box hour-available";
        box.textContent = "Available";
        box.onclick = () => mockPay(key, h);
      }

      cell.appendChild(box);
      weekBody.appendChild(cell);
    }
  }
}

// -----------------------------
// MAIN RENDER LOOP
// -----------------------------
function render() {
  view === "week" ? renderWeek() : renderMonth();
}

render();
</script>
